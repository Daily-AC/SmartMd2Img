# AstrBot 智能Markdown转图片插件

一个更智能的AstrBot插件，能够自动检测复杂的Markdown格式并转换为图片，提升在QQ等平台的消息显示效果。

## 新特性 🚀

### 智能自动检测
插件现在能够自动识别以下复杂格式并转换为图片：
- **代码块** (```code```)
- **数学公式** (行内 `$...$` 和块级 `$$...$$`)
- **表格** (Markdown表格)
- **复杂嵌套列表**
- **多个标题组合**
- **长文本** (超过15行或包含多行长行)

### 智能保留简单格式
以下简单格式会保持文本直接发送：
- 粗体、斜体
- 简单列表
- 单个标题
- 链接
- 短文本消息

### 灵活配置
- **自动检测开关**: 可关闭自动检测，仅使用`<md>`标签
- **复杂度阈值**: 调整触发转换的敏感度
- **显式标签尊重**: 可选择是否处理显式的`<md>`标签

## 功能特性

- ✅ **智能Markdown转图片**: 自动检测复杂格式并转换为清晰图片
- ✅ **LaTeX 数学公式支持**: 通过 MathJax 完美渲染数学公式
- ✅ **自动浏览器安装**: 插件自动安装和配置 Playwright Chromium 浏览器
- ✅ **智能识别**: 自动判断何时使用图片渲染功能
- ✅ **高清渲染**: 支持 2 倍缩放，生成高质量图片
- ✅ **自适应宽度**: 支持固定宽度或自适应宽度渲染
- ✅ **向后兼容**: 仍然支持原有的`<md>`标签方式

## 安装方法

### 前置要求

- Python 3.8+
- AstrBot 框架

### 安装步骤

1. 将插件文件夹放置到 AstrBot 的 `plugins` 目录下
2. 重启 AstrBot 服务
3. 插件会自动安装所需依赖（`mistune` 和 `playwright`）

## 使用方法

### 智能模式（推荐）

只需正常使用Markdown编写消息，插件会自动判断何时需要转换为图片：


这是一个简单的消息，**粗体**和*斜体*会直接显示。

但当包含代码时：
```python
def complex_function():
    # 这段代码会自动转换为图片
    return "Hello World"
```

数学公式也会自动转换：
$E = mc^2$ 和 $$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$


### 手动模式

如需强制转换，仍可使用`<md>`标签：

```
<md>
# 强制转换为图片
即使这是简单内容，也会被转换为图片。
</md>
```

### 支持的 Markdown 语法

- ✅ 标题（#、##、###）
- ✅ 列表（有序、无序）
- ✅ 代码块（语法高亮）
- ✅ 表格
- ✅ 数学公式（LaTeX）
- ✅ 粗体、斜体、删除线
- ✅ 引用块
- ✅ 水平分割线

### 数学公式示例

```
行内公式：$a^2 + b^2 = c^2$

独立公式：
$$
\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}
$$
```

## 配置说明

### 插件配置

在插件代码中可调整以下参数：

```python
self.auto_detect = True  # 开启自动检测
self.min_complexity_score = 2  # 复杂度阈值（1-5）
self.always_convert_codes = True  # 始终转换代码块
self.respect_md_tags = True  # 尊重显式标签
```

### 依赖包

- `mistune`: Markdown 解析器
- `playwright`: 浏览器自动化工具（用于渲染）

## 检测规则

### 一定会触发转换的内容：
- 包含代码块 (```)
- 包含数学公式 ($...$ 或 $$...$$)
- 包含Markdown表格
- 显式使用`<md>`标签

### 可能触发转换的内容（基于复杂度评分）：
- 多个复杂元素组合
- 超过15行的长文本
- 包含多行超过80字符的文本
- 复杂嵌套结构

## 技术实现

### 渲染流程

1. **复杂度检测**: 使用智能检测器分析Markdown内容复杂度
2. **解析 Markdown**: 使用 `mistune` 将 Markdown 转换为 HTML
3. **数学公式处理**: 通过 MathJax 渲染 LaTeX 公式
4. **浏览器渲染**: 使用 Playwright Chromium 浏览器截图
5. **图片生成**: 生成 PNG 格式的高清图片

### 图片缓存

生成的图片存储在 `data/md2img_cache/` 目录下，使用 UUID 作为文件名确保唯一性。

## 优势

1. **更智能**: 无需手动标记，自动识别复杂格式
2. **更高效**: 简单消息直接发送，减少图片生成
3. **更友好**: 用户在QQ中既能复制简单文本，又能看到复杂格式的完美渲染
4. **更灵活**: 提供多种配置选项适应不同需求

## 备注

首次安装依赖较多，会在后台异步安装依赖，请在控制台中跟踪进度。

如果遇到任何问题，可以：
1. 关闭自动检测，仅使用`<md>`标签
2. 调整复杂度阈值参数
3. 检查Playwright浏览器是否正确安装